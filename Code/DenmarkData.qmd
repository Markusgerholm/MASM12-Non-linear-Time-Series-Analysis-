---
title: "DenmarkData"
format: html
---

```{r}
setwd("..")
source("Code/DenmarkFunctions.r")
```

Â 

```{R}
#get all stations
stations <- get_stations()
head(stations)
```

```{R}
station_id <- "06041" #Skagen Fyr
params <- get_station_available_parameters(station_id)
print(params)

```

```{r}

# Get available parameters for the station
params <- c("temp_dry","wind_dir","wind_speed")

# Set datetime range (ISO 8601 UTC)
start_time <- "2024-05-04T23:00:00Z"
end_time   <- "2024-09-06T23:00:00Z"

# Fetch observations
observations <- get_observations_for_station(
  station_id = station_id,
  parameters = params,   # or subset of parameters
  start_dt   = start_time,
  end_dt     = end_time,
  limit      = 20000
)


```

```{r}
head(observations)
```

downsample data

```{r}
full_seq <- seq(
  from = min(observations$observed),
  to   = max(observations$observed),
  by   = "10 min"
)

# Find missing timestamps
missing_times <- full_seq[!full_seq %in% observations$observed]

# Summary
length(missing_times)  # how many are missing
missing_times           # which timestamps are missing
```

```{r}
# Ensure observed is POSIXct
observations <- observations %>%
  mutate(observed = as.POSIXct(observed, format = "%Y-%m-%dT%H:%M:%OSZ", tz = "UTC")) %>%
  arrange(observed)

# Create a full 10-minute sequence as a data frame
full_seq <- data.frame(observed = seq(
  from = min(observations$observed),
  to   = max(observations$observed),
  by   = "10 min"
))

# Merge: observations must also be a data frame
observations_df <- as.data.frame(observations)

# Add missing rows as NA
complete_obs <- full_seq %>%
  left_join(observations_df, by = "observed") %>%
  arrange(observed)
```

```{r}
library(zoo)

# Assume complete_obs has 'observed' and several parameter columns
interpolated_obs <- complete_obs %>%
  arrange(observed) %>%
  mutate(across(
    .cols = -observed,                # interpolate all columns except 'observed'
    .fns  = ~ na.approx(., x = observed, na.rm = FALSE, maxgap = 6)  # only interpolate gaps <= 6 points (1 hour)
  ))
```

```{r}
library(lubridate)
hourly_dmi <- interpolated_obs %>%
  # Round to nearest 10 minutes to correct minor misalignments
  mutate(observed = round_date(observed, unit = "10 minutes")) %>%
  # Keep only observations where minute = 0 (top of the hour)
  filter(minute(observed) == 0)
```
