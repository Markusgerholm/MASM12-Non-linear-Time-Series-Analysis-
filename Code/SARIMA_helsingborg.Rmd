---
title: "SARIMA_helsingborg"
output: html_document
---

## TO DO

Kolla vindriktning säsongsvis från Helsingborg Hypotes: sällan vind norr ifrån -\>

## Loading data

```{r}
setwd("..")
source("Code/read_data.r")
```

```{r}
library(zoo)
library(forecast)
library(ggplot2)
library(dplyr)
```

```{r}
helsingborg_2024_2025 <- helsingborg %>%
  filter(
    ts_utc >= as.POSIXct("2024-01-01 00:00:00", tz = "UTC"),
    ts_utc <= as.POSIXct("2025-08-31 23:59:59", tz = "UTC")
  )
nidingen_2024_2025 <- nidingen %>%
  filter(
    ts_utc >= as.POSIXct("2024-01-01 00:00:00", tz = "UTC"),
    ts_utc <= as.POSIXct("2025-08-31 23:59:59", tz = "UTC")
  )
hörby_2024_2025 <- hörby %>%
  filter(
    ts_utc >= as.POSIXct("2024-01-01 00:00:00", tz = "UTC"),
    ts_utc <= as.POSIXct("2025-08-31 23:59:59", tz = "UTC")
  )
falsterbo_2024_2025 <- falsterbo %>%
  filter(
    ts_utc >= as.POSIXct("2024-01-01 00:00:00", tz = "UTC"),
    ts_utc <= as.POSIXct("2025-08-31 23:59:59", tz = "UTC")
  )
skillinge_2024_2025 <- skillinge %>%
  filter(
    ts_utc >= as.POSIXct("2024-01-01 00:00:00", tz = "UTC"),
    ts_utc <= as.POSIXct("2025-08-31 23:59:59", tz = "UTC")
  )
ullared_2024_2025 <- ullared %>%
  filter(
    ts_utc >= as.POSIXct("2024-01-01 00:00:00", tz = "UTC"),
    ts_utc <= as.POSIXct("2025-08-31 23:59:59", tz = "UTC")
  )
ljungby_2024_2025 <- ljungby %>%
  filter(
    ts_utc >= as.POSIXct("2024-01-01 00:00:00", tz = "UTC"),
    ts_utc <= as.POSIXct("2025-08-31 23:59:59", tz = "UTC")
  )
hästveda_2024_2025 <- hästveda %>%
  filter(
    ts_utc >= as.POSIXct("2024-01-01 00:00:00", tz = "UTC"),
    ts_utc <= as.POSIXct("2025-08-31 23:59:59", tz = "UTC")
  )
```

## "Stationary" period

```{r}
start <- 3200
end <- 5900
df_he <- helsingborg_2024_2025[start:end, ] # center
df_ni <- nidingen_2024_2025[start:end, ] # north west
df_fa <- falsterbo_2024_2025[start:end, ] # south
df_hä <- hästveda_2024_2025[start:end, ] # east north east
df_lj <- ljungby_2024_2025[start:end, ] # north east
df_ul <- ullared_2024_2025[start:end, ] # north
df_sk <- skillinge_2024_2025[start:end, ] # south east
df_hö <- hörby_2024_2025[start:end, ] # east
```

## Training and testing split

```{r}
h <- 500
freq <- 24
# full series from your dataframe
y_all <- ts(helsingborg_2024_2025$Lufttemperatur, frequency = 24)

# convert row indices to ts "time" values
t_start <- 1 + (start - 1) / freq
t_end   <- 1 + (end   - 1) / freq
t_test_start <- 1 + (end) / freq          # row end + 1
t_test_end   <- 1 + (end + h - 1) / freq  # row end + h

# train/test as ts
y_train <- window(y_all, start = t_start, end = t_end)
y_test  <- window(y_all, start = t_test_start, end = t_test_end)

# additional test set roughly 6 months forward in time

gap <- 4000  

t_test1_start <- t_test_start + gap / freq
t_test1_end   <- t_test1_start + (h - 1) / freq

y_test1 <- window(y_all, start = t_test1_start, end = t_test1_end)

```

## Plot of training data - looks reasonably stationary

```{r}
plot(y_train)
```

## Fixed and non-fixed parameters in p/q polynomials

```{r}
p <- rep(0, 18)
p[1] <- NA
p[2] <- NA
p[11] <- 0
p[18] <- NA

q <- rep(0, 23)
q[2] <- NA
q[20] <- NA
q[23] <- NA
```

## Seasonal ARIMA model:

```{r}
fit <- Arima(y_train,
                 order = c(18,0,23),
                fixed = c(p,q,NA),
                 seasonal = c(0,1,1))
summary(fit)
```

## ACF/PACF of model's residuals

```{r}
r <-  acf(as.numeric(fit$residuals), lag.max = 50, na.action = na.omit, xaxt = "n", plot = FALSE)
r$acf[1] <- NA
plot(r, main = "ACF", xaxt = "n")
axis(1, at = 0:100, labels = 0:100)   # label every lag
pacf(as.numeric(fit$residuals), lag.max = 50, na.action = na.omit, xaxt = "n", main = "PACF")
axis(1, at = 0:100, labels = 0:100)   # label every lag

```

## Plotting fitted values against observed values

```{r}
autoplot(y_train, series = "Observed") +
  autolayer(fitted(fit), series = "Fitted") +
  labs(title = "Observed vs fitted", x = "Time", y = NULL)
```

## Plotting k-step predictions on first test data

```{r}
# Apply the SAME fitted model to (train+test) WITHOUT re-estimation
y_train_test <- window(y_all, start = t_start, end = t_test_end)
refit <- Arima(y_train_test, model = fit)   # parameters held fixed

# k-step-ahead predictions for the test period (rolling, no refit)
k <- 24
h <- length(y_test)

k_step_vals <- numeric(h - k)

for (i in 1:(h - k)) {
  t_origin <- 1 + (end + i - 1) / frequency(y_all)  # row end+i (includes y_test[i])
  y_up_to  <- window(y_all, start = t_start, end = t_origin)
  refit_i  <- Arima(y_up_to, model = fit)           # update state only
  k_step_vals[i] <- forecast(refit_i, h = k)$mean[k]
}

k_step_test <- ts(k_step_vals,
                  start = time(y_test)[k + 1],
                  frequency = frequency(y_test))

# Plot: actual test vs k-step-ahead preds (aligned)
ts.plot(window(y_test, start = time(y_test)[k + 1]), k_step_test,
        col = c("blue", "red"), lwd = c(1,1),
        main = paste0("Test actuals vs ", k, "-step-ahead predictions (no refit)"),
        ylab = "Temperature", xlab = "Time")
legend("topleft", legend = c("Test actuals", paste0(k, "-step ahead")),
       col = c("blue", "red"), lwd = c(2,2), bty = "n")
```

## Plotting k-step predictions on second test data

```{r}
# Apply the SAME fitted model to (train+test1) WITHOUT re-estimation
y_train_test1 <- window(y_all, start = t_start, end = t_test1_end)
refit <- Arima(y_train_test1, model = fit)   # parameters held fixed

# k-step-ahead predictions for the test1 period (rolling, no refit)
k <- 24
h <- length(y_test1)

k_step_vals <- numeric(h - k)
test1_start_idx <- as.integer( round((t_test1_start - 1) * frequency(y_all)) ) + 1

for (i in 1:(h - k)) {
  t_origin <- 1 + (test1_start_idx + i - 1) / frequency(y_all)  # includes y_test1[i]
  y_up_to  <- window(y_all, start = t_start, end = t_origin)
  refit_i  <- Arima(y_up_to, model = fit)           # update state only
  k_step_vals[i] <- forecast(refit_i, h = k)$mean[k]
}

k_step_test1 <- ts(k_step_vals,
                   start = time(y_test1)[k + 1],
                   frequency = frequency(y_test1))

# Plot: actual test1 vs k-step-ahead preds (aligned)
ts.plot(window(y_test1, start = time(y_test1)[k + 1]), k_step_test1,
        col = c("blue", "red"), lwd = c(1,1),
        main = paste0("Test1 actuals vs ", k, "-step-ahead predictions (no refit)"),
        ylab = "Temperature", xlab = "Time")
legend("topleft", legend = c("Test1 actuals", paste0(k, "-step ahead")),
       col = c("blue", "red"), lwd = c(2,2), bty = "n")

```

## Adding residuals to df

```{r}
df_he$res <- fit$residuals
```

## Checking where wind comes from

## Regimes for wind direction:

```{r}
wind_regime <- function(wd, ws, rot = 45) {
  wd <- (wd - rot) %% 360
  out <- rep(NA_character_, length(wd))

  # Only assign R1–R4 when wind speed is not zero, when zero, set regime to R5
  idx <- !is.na(ws) & ws != 0 & !is.na(wd)
 
  out[!is.na(ws) & ws == 0] <- "R0"
  out[idx & wd >   0 & wd <=  90] <- "R1"
  out[idx & wd >  90 & wd <= 180] <- "R2"
  out[idx & wd > 180 & wd <= 270] <- "R3"
  out[idx & wd > 270 & wd <  360] <- "R4"
  out[idx & wd == 0]              <- "R4"

  factor(out, levels = c("R0","R1","R2","R3","R4"))

}

df_he$regime <- wind_regime(df_he$Vindriktning, df_he$Vindhastighet, rot = 45)
```

## 8 wind regimes

```{r}
wind_regime <- function(wd, ws, rot = 45) {
  wd <- (wd - rot) %% 360
  out <- rep(NA_character_, length(wd))

  # Only assign R1–R4 when wind speed is not zero, when zero, set regime to R5
  idx <- !is.na(ws) & ws != 0 & !is.na(wd)
 
  out[!is.na(ws) & ws == 0] <- "R0"
  out[idx & wd >   0 & wd <=  45] <- "R1"
  out[idx & wd >  45 & wd <= 90] <- "R2"
  out[idx & wd >  90 & wd <= 135] <- "R3"
  out[idx & wd >  135 & wd <= 180] <- "R4"
  out[idx & wd > 180 & wd <= 225] <- "R5"
  out[idx & wd > 225 & wd <  270] <- "R6"
  out[idx & wd > 270 & wd <  315] <- "R7"
  out[idx & wd > 315 & wd <  360] <- "R8"
  out[idx & wd == 0]              <- "R8"

  factor(out, levels = c("R0","R1","R2", "R3","R4","R5", "R6", "R7", "R8"))

}

df_he$regime <- wind_regime(df_he$Vindriktning, df_he$Vindhastighet, rot = 45)
```

```{r}
plot_regime_compass <- function(rot = 0, show_calm = TRUE, calm_radius = 0.25) {

  regimes <- data.frame(
    name = paste0("R", 1:8),
    from = c(0, 45, 90, 135, 180, 225, 270, 315) + rot,
    to   = c(45, 90, 135, 180, 225, 270, 315, 360) + rot
  )

  plot(0, 0, type="n", asp=1, xlim=c(-1.2,1.2), ylim=c(-1.2,1.2),
       axes=FALSE, xlab="", ylab="")
  symbols(0, 0, circles=1, inches=FALSE, add=TRUE)

  deg2rad <- function(deg) (90 - deg) * pi/180  # 0° = North at top

  # Draw R1–R8 sectors
  for (i in 1:nrow(regimes)) {
    a1 <- deg2rad(regimes$from[i])
    a2 <- deg2rad(regimes$to[i])
    th <- seq(a1, a2, length.out = 200)

    polygon(c(0, cos(th), 0), c(0, sin(th), 0), border="black")
    mid <- deg2rad((regimes$from[i] + regimes$to[i]) / 2)
    text(0.75*cos(mid), 0.75*sin(mid), regimes$name[i], cex=1.2)
  }

  # Draw R0 (calm: Vindhastighet == 0) as center circle
  if (show_calm) {
    symbols(0, 0, circles=calm_radius, inches=FALSE, add=TRUE,
            fg="black", bg="grey90")
    text(0, 0, "R0", cex=1.1)
  }

  # Cardinal directions
  text(0,  1.1, "N"); text(1.1, 0, "E"); text(0, -1.1, "S"); text(-1.1, 0, "W")
}

plot_regime_compass(rot = 45)

```


```{r}
plot_regime_compass <- function(rot = 0) {
  regimes <- data.frame(
    name = c("R1","R2","R3","R4"),
    from = c(0, 90, 180, 270) + rot,
    to   = c(90, 180, 270, 360) + rot
  )

  plot(0, 0, type="n", asp=1, xlim=c(-1.2,1.2), ylim=c(-1.2,1.2),
       axes=FALSE, xlab="", ylab="")
  symbols(0, 0, circles=1, inches=FALSE, add=TRUE)

  deg2rad <- function(deg) (90 - deg) * pi/180  # 0° = North at top

  for (i in 1:nrow(regimes)) {
    a1 <- deg2rad(regimes$from[i])
    a2 <- deg2rad(regimes$to[i])
    th <- seq(a1, a2, length.out = 200)

    polygon(c(0, cos(th), 0), c(0, sin(th), 0), border="black")
    mid <- deg2rad((regimes$from[i] + regimes$to[i]) / 2)
    text(0.75*cos(mid), 0.75*sin(mid), regimes$name[i], cex=1.2)
  }

  text(0,  1.1, "N"); text(1.1, 0, "E"); text(0, -1.1, "S"); text(-1.1, 0, "W")
}

plot_regime_compass(rot =45)

```

```{r}
# 16 compass directions
labels16 <- c("N","NNE","NE","ENE","E","ESE","SE","SSE",
              "S","SSW","SW","WSW","W","WNW","NW","NNW")

# wind speed bins
spd_breaks <- c(0,2,4,6,8,10,12,14,16,18,20,Inf)
spd_labels <- c("0–2","2–4","4–6","6–8","8–10","10–12",
                "12–14","14–16","16–18","18–20","20+")

# prepare data
rose_df <- df_he %>%
  filter(!is.na(Vindriktning), !is.na(Vindhastighet), Vindhastighet != 0) %>%
  mutate(
    wd = Vindriktning %% 360,
    dir16 = labels16[(floor((wd + 11.25) / 22.5) %% 16) + 1],
    dir16 = factor(dir16, levels = labels16, ordered = TRUE),
    spd_bin = cut(Vindhastighet,
                  breaks = spd_breaks, labels = spd_labels,
                  include.lowest = TRUE, right = FALSE)
  ) %>%
  count(dir16, spd_bin) %>%
  mutate(pct = 100 * n / sum(n))

# plot with original color theme (no theme_minimal)
ggplot(rose_df, aes(x = dir16, y = pct, fill = spd_bin)) +
  geom_col(width = 1, color = "grey30") +
  coord_polar(start = -pi/16, direction = 1) +  # North at top, clockwise
  labs(x = NULL, y = NULL, fill = "Wind speed (m/s)") 

```

```{r}
library(dplyr)
library(ggplot2)

# compute mean wind speed per regime
rose_mean <- df_he %>%
  filter(!is.na(regime), !is.na(Vindhastighet), Vindhastighet != 0) %>%
  mutate(regime = factor(regime, levels = c("R1","R2","R3","R4"))) %>%
  group_by(regime) %>%
  summarise(mean_speed = mean(Vindhastighet), .groups = "drop")

# polar plot with 45-degree rotation
# each bar represents a regime sector rotated by 45 degrees
ggplot(rose_mean, aes(x = regime, y = mean_speed)) +
  geom_col(width = 1, color = "black") +
  coord_polar(start = pi/4, direction = 1) +  # ✅ change -1 → 1 for clockwise
  labs(
    x = NULL,
    y = "Mean Vindhastighet (m/s)",
    title = "Helsingborg: mean wind speed by regime (rotated 45°)"
  )


```

## Add danish weather station

```{r}
setwd("..")
source("Code/DenmarkFunctions.r")
```

```{r}
#Can see locations of weather stations here https://www.dmi.dk/maalinger see DenmarkData file to search for station ids
station_id = "06079" #Anholt maybe not that interesting?
station_id <- "06041" #Skagen Fyr has >0.1 corss correlation in R4, but is very far away...
station_id <- "06180" #copenhagen airport could be good?
station_id <- "06049" #Gniben also potential good alternative for wind from the west
station_id <- "06168" #Nakkehoved Fyr has some correlations in R3 for example
station_id <- "06170" #Roskilde Lufthavn has very strong autocorrelation in general. Not just in certain regimes. May be too close?
station_id <- "06073"#Sletterhage Fyr.
station_id <- "06120" #H.C Andersen Airport. Has lagged correlation
# Get available parameters for the station
params <- c("temp_dry","wind_dir","wind_speed")

start_time <- format(as.POSIXct(df_he$ts_utc[1], tz = "UTC"),
       "%Y-%m-%dT%H:%M:%SZ")
end_time <- format(as.POSIXct(df_he$ts_utc[nrow(df_he)], tz = "UTC"),
       "%Y-%m-%dT%H:%M:%SZ")

# change to desired station
station_id <- "06180" 

# Fetch observations
observations <- get_observations_for_station(
  station_id = station_id,
  parameters = params,   # or subset of parameters
  start_dt   = start_time,
  end_dt     = end_time,
  limit      = 20000
)
```

```{r}
full_seq <- seq(
  from = min(observations$observed),
  to   = max(observations$observed),
  by   = "10 min"
)

# Find missing timestamps
missing_times <- full_seq[!full_seq %in% observations$observed]

# Summary
length(missing_times)  # how many are missing
missing_times           # which timestamps are missing
```

```{r}
#process data so it is hourly
hourly_dmi <- process_hourly_data(observations)
```

```{r}
#rename columns to match swedish data
hourly_dmi <- hourly_dmi %>%
  rename(Lufttemperatur = temp_dry, Vindriktning = wind_dir, Vindhastighet = wind_speed, ts_utc = observed)
```

```{r}
fit_x <- auto.arima(hourly_dmi$Lufttemperatur)
innov_x <- residuals(fit_x)
hourly_dmi$res <- innov_x
```

```{r}
#ccf without regime filtering
ccf(as.numeric(hourly_dmi$res),as.numeric(df_he$res), lag.max = 48,na.action = na.pass)
```

```{r}
df_he_R <- filter(df_he, regime == "R1")

# times where Helsingborg is in R1
t_R <- df_he_R$ts_utc

# align other station to same times
df_x <- hourly_dmi[hourly_dmi$ts_utc %in% t_R, ]

# CCF: station -> Helsingborg
r <- ccf(df_x$res, df_he_R$res,
         lag.max = 50, na.action = na.pass, plot = FALSE)

pos <- r$lag >= 0

n <- sum(complete.cases(df_x$res, df_he_R$res))
ci <- 1.96 / sqrt(n)

plot(r$lag[pos], r$acf[pos], type = "h",
     xlab = "Lag",
     ylab = "CCF",
     main = "CCF")

abline(h = 0)
abline(h = c(-ci, ci), lty = 2)
```

```{r}
df_he_R <- filter(df_he, regime == "R4")

# times where Helsingborg is in R1
t_R <- df_he_R$ts_utc

df_x <- df_ul

fit_x <- auto.arima(df_x$Lufttemperatur)
innov_x <- residuals(fit_x)
df_x$res <- innov_x

# align other station to same times
df_x <- df_x[df_x$ts_utc %in% t_R, ]

# CCF: station -> Helsingborg
r <- ccf(df_x$res, df_he_R$res,
         lag.max = 50, na.action = na.pass, plot = FALSE)

pos <- r$lag >= 0

n <- sum(complete.cases(df_x$res, df_he_R$res))
ci <- 1.96 / sqrt(n)

plot(r$lag[pos], r$acf[pos], type = "h",
     xlab = "Lag",
     ylab = "CCF",
     main = "CCF")

abline(h = 0)
abline(h = c(-ci, ci), lty = 2)

```

## Filtering based on regime

```{r}
plot_ccf_with_prewhitened_station <- function(df_he,
                                              df_x,
                                              regimes = c("R1", "R2", "R3", "R4", "R5", "R6", "R7", "R8"),
                                              time_col = "ts_utc",
                                              value_col = "Lufttemperatur",
                                              lag_max = 50) {
  
  library(dplyr)
  library(forecast)
  
  ## -----------------------------
  ## Prewhiten station (once)
  ## -----------------------------
  fit_x <- auto.arima(df_x[[value_col]])
  df_x$res <- residuals(fit_x)  # keep as ts
  
  ## -----------------------------
  ## Loop over regimes → separate plots
  ## -----------------------------
  for (reg in regimes) {
    
    df_he_R <- df_he %>% filter(regime == !!reg)
    t_R <- df_he_R[[time_col]]
    
    # Align station to regime times
    df_x_R <- df_x[df_x[[time_col]] %in% t_R, ]
    
    r <- ccf(df_x_R$res,
             df_he_R$res,
             lag.max = lag_max,
             na.action = na.pass,
             plot = FALSE)
    
    pos <- r$lag >= 0
    n <- sum(complete.cases(df_x_R$res, df_he_R$res))
    ci <- 1.96 / sqrt(n)
    
    plot(r$lag[pos], r$acf[pos], type = "h",
         xlab = "Lag",
         ylab = "CCF",
         main = paste("CCF –", reg, "(station prewhitened)"))
    
    abline(h = 0)
    abline(h = c(-ci, ci), lty = 2)
  }
}

```

### R1
## Hästveda
```{r}
plot_ccf_with_prewhitened_station(
  df_he = df_he,
  df_x  = df_hä,
  regimes = "R1"
)
```

### R2
## Hörby
```{r}
plot_ccf_with_prewhitened_station(
  df_he = df_he,
  df_x  = df_hö,
  regimes = "R2"
)
```

### R3
## Skillinge
```{r}
plot_ccf_with_prewhitened_station(
  df_he = df_he,
  df_x  = df_sk,
  regimes = "R3"
)
```

### R4
## Falsterbo
```{r}
plot_ccf_with_prewhitened_station(
  df_he = df_he,
  df_x  = df_fa,
  regimes = "R4"
)
```
## Köbenhavn lufthavn
```{r}
plot_ccf_with_prewhitened_station(
  df_he = df_he,
  df_x  = df_kb,
  regimes = "R4"
)
```
## Roskilde Lufthavn
```{r}
plot_ccf_with_prewhitened_station(
  df_he = df_he,
  df_x  = df_ro,
  regimes = "R4"
)
```

### R5
## Roskilde lufthavn

## Gniben

## Sletterhage fyr

### R6
## Anholt


### R7
## Nidingen
```{r}
plot_ccf_with_prewhitened_station(
  df_he = df_he,
  df_x  = df_ni,
  regimes = "R7"
)
```
## Ullared
```{r}
plot_ccf_with_prewhitened_station(
  df_he = df_he,
  df_x  = df_ul,
  regimes = "R7"
)
```

### R8
##Ljungby
```{r}
plot_ccf_with_prewhitened_station(
  df_he = df_he,
  df_x  = df_lj,
  regimes = "R8"
)
```





```{r}
plot_ccf_with_prewhitened_station(
  df_he = df_he,
  df_x  = df_lj
)
```

```{r}
plot_ccf_with_prewhitened_station(
  df_he = df_he,
  df_x  = df_ni
)
```

```{r}
plot_ccf_with_prewhitened_station(
  df_he = df_he,
  df_x  = df_sk
)
```

```{r}
plot_ccf_with_prewhitened_station(
  df_he = df_he,
  df_x  = df_hö
)
```

```{r}
df_he_R <- filter(df_he, regime == "R4")

# times where df_h is R1<
t_R <- df_he_R$ts_utc

# keep those times in df_ä
#df_temp <- df_fa
df_temp <- hourly_dmi 
df_x <- df_temp[df_temp$ts_utc %in% t_R, ]

#idx_missing <- which(is.na(df_x$Lufttemperatur))  # TRUE for NA and NaN

r = ccf(df_x$res, df_he_R$res, lag.max = 50, na.action = na.pass, plot = FALSE)
pos <- r$lag >= 0

n <- sum(complete.cases(df_he_R$res, df_x$Lufttemperatur))
ci <- 1.96 / sqrt(n)

plot(r$lag[pos], r$acf[pos], type = "h",
     xlab = "Lag", ylab = "CCF (positive lags)", main = "CCF")
abline(h = 0)
abline(h = c(-ci, ci), lty = 2)
```

# R1: East: Hästveda?

# R2:

# R3:

# R4: North

Note: Many stations seem to have high correlations at R4. R4 has low wind speed and is very limited in terms of the wind directions

## CCF R3 Falsterbo

```{r}
#df_he_R <- diff(df_he_R$res, lag = 1)
#df_x <- diff(df_x$Lufttemperatur, lag = 1)
ccf(df_he_R$res, df_x$Lufttemperatur, lag.max = 50, na.action = na.pass)
```
