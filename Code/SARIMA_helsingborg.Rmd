---
title: "SARIMA_helsingborg"
output: html_document
---

## TO DO

Kolla vindriktning säsongsvis från Helsingborg Hypotes: sällan vind norr ifrån -\>

## Loading data

```{r}
setwd("..")
source("Code/read_data.r")
```

```{r}
library(zoo)
library(forecast)
library(ggplot2)
library(dplyr)
```

```{r}
helsingborg_2024_2025 <- helsingborg %>%
  filter(
    ts_utc >= as.POSIXct("2024-01-01 00:00:00", tz = "UTC"),
    ts_utc <= as.POSIXct("2025-08-31 23:59:59", tz = "UTC")
  )
nidingen_2024_2025 <- nidingen %>%
  filter(
    ts_utc >= as.POSIXct("2024-01-01 00:00:00", tz = "UTC"),
    ts_utc <= as.POSIXct("2025-08-31 23:59:59", tz = "UTC")
  )
hörby_2024_2025 <- hörby %>%
  filter(
    ts_utc >= as.POSIXct("2024-01-01 00:00:00", tz = "UTC"),
    ts_utc <= as.POSIXct("2025-08-31 23:59:59", tz = "UTC")
  )
falsterbo_2024_2025 <- falsterbo %>%
  filter(
    ts_utc >= as.POSIXct("2024-01-01 00:00:00", tz = "UTC"),
    ts_utc <= as.POSIXct("2025-08-31 23:59:59", tz = "UTC")
  )
skillinge_2024_2025 <- skillinge %>%
  filter(
    ts_utc >= as.POSIXct("2024-01-01 00:00:00", tz = "UTC"),
    ts_utc <= as.POSIXct("2025-08-31 23:59:59", tz = "UTC")
  )
ullared_2024_2025 <- ullared %>%
  filter(
    ts_utc >= as.POSIXct("2024-01-01 00:00:00", tz = "UTC"),
    ts_utc <= as.POSIXct("2025-08-31 23:59:59", tz = "UTC")
  )
ljungby_2024_2025 <- ljungby %>%
  filter(
    ts_utc >= as.POSIXct("2024-01-01 00:00:00", tz = "UTC"),
    ts_utc <= as.POSIXct("2025-08-31 23:59:59", tz = "UTC")
  )
hästveda_2024_2025 <- hästveda %>%
  filter(
    ts_utc >= as.POSIXct("2024-01-01 00:00:00", tz = "UTC"),
    ts_utc <= as.POSIXct("2025-08-31 23:59:59", tz = "UTC")
  )
```

## "Stationary" period

```{r}
start <- 3200
end <- 5900
df_he <- helsingborg_2024_2025[start:end, ] # center
df_ni <- nidingen_2024_2025[start:end, ] # north west
df_fa <- falsterbo_2024_2025[start:end, ] # south
df_hä <- hästveda_2024_2025[start:end, ] # east north east
df_lj <- ljungby_2024_2025[start:end, ] # north east
df_ul <- ullared_2024_2025[start:end, ] # north
df_sk <- skillinge_2024_2025[start:end, ] # south west
df_hö <- hörby_2024_2025[start:end, ] # east
```

## Training and testing split

```{r}
h <- 500
freq <- 24
# full series from your dataframe
y_all <- ts(helsingborg_2024_2025$Lufttemperatur, frequency = 24)

# convert row indices to ts "time" values
t_start <- 1 + (start - 1) / freq
t_end   <- 1 + (end   - 1) / freq
t_test_start <- 1 + (end) / freq          # row end + 1
t_test_end   <- 1 + (end + h - 1) / freq  # row end + h

# train/test as ts
y_train <- window(y_all, start = t_start, end = t_end)
y_test  <- window(y_all, start = t_test_start, end = t_test_end)

# additional test set roughly 6 months forward in time

gap <- 4000  

t_test1_start <- t_test_start + gap / freq
t_test1_end   <- t_test1_start + (h - 1) / freq

y_test1 <- window(y_all, start = t_test1_start, end = t_test1_end)

```

## Plot of training data - looks reasonably stationary

```{r}
plot(y_train)
```

## Fixed and non-fixed parameters in p/q polynomials

```{r}
p <- rep(0, 18)
p[1] <- NA
p[2] <- NA
p[11] <- 0
p[18] <- NA

q <- rep(0, 23)
q[2] <- NA
q[20] <- NA
q[23] <- NA
```

## Seasonal ARIMA model:

```{r}
fit <- Arima(y_train,
                 order = c(18,0,23),
                fixed = c(p,q,NA),
                 seasonal = c(0,1,1))
summary(fit)
```

## ACF/PACF of model's residuals

```{r}
r <-  acf(as.numeric(fit$residuals), lag.max = 50, na.action = na.omit, xaxt = "n", plot = FALSE)
r$acf[1] <- NA
plot(r, main = "ACF", xaxt = "n")
axis(1, at = 0:100, labels = 0:100)   # label every lag
pacf(as.numeric(fit$residuals), lag.max = 50, na.action = na.omit, xaxt = "n", main = "PACF")
axis(1, at = 0:100, labels = 0:100)   # label every lag

```

## Plotting fitted values against observed values

```{r}
autoplot(y_train, series = "Observed") +
  autolayer(fitted(fit), series = "Fitted") +
  labs(title = "Observed vs fitted", x = "Time", y = NULL)
```

## Plotting k-step predictions on first test data

```{r}
# Apply the SAME fitted model to (train+test) WITHOUT re-estimation
y_train_test <- window(y_all, start = t_start, end = t_test_end)
refit <- Arima(y_train_test, model = fit)   # parameters held fixed

# k-step-ahead predictions for the test period (rolling, no refit)
k <- 24
h <- length(y_test)

k_step_vals <- numeric(h - k)

for (i in 1:(h - k)) {
  t_origin <- 1 + (end + i - 1) / frequency(y_all)  # row end+i (includes y_test[i])
  y_up_to  <- window(y_all, start = t_start, end = t_origin)
  refit_i  <- Arima(y_up_to, model = fit)           # update state only
  k_step_vals[i] <- forecast(refit_i, h = k)$mean[k]
}

k_step_test <- ts(k_step_vals,
                  start = time(y_test)[k + 1],
                  frequency = frequency(y_test))

# Plot: actual test vs k-step-ahead preds (aligned)
ts.plot(window(y_test, start = time(y_test)[k + 1]), k_step_test,
        col = c("blue", "red"), lwd = c(1,1),
        main = paste0("Test actuals vs ", k, "-step-ahead predictions (no refit)"),
        ylab = "Temperature", xlab = "Time")
legend("topleft", legend = c("Test actuals", paste0(k, "-step ahead")),
       col = c("blue", "red"), lwd = c(2,2), bty = "n")
```

## Plotting k-step predictions on second test data

```{r}
# Apply the SAME fitted model to (train+test1) WITHOUT re-estimation
y_train_test1 <- window(y_all, start = t_start, end = t_test1_end)
refit <- Arima(y_train_test1, model = fit)   # parameters held fixed

# k-step-ahead predictions for the test1 period (rolling, no refit)
k <- 24
h <- length(y_test1)

k_step_vals <- numeric(h - k)
test1_start_idx <- as.integer( round((t_test1_start - 1) * frequency(y_all)) ) + 1

for (i in 1:(h - k)) {
  t_origin <- 1 + (test1_start_idx + i - 1) / frequency(y_all)  # includes y_test1[i]
  y_up_to  <- window(y_all, start = t_start, end = t_origin)
  refit_i  <- Arima(y_up_to, model = fit)           # update state only
  k_step_vals[i] <- forecast(refit_i, h = k)$mean[k]
}

k_step_test1 <- ts(k_step_vals,
                   start = time(y_test1)[k + 1],
                   frequency = frequency(y_test1))

# Plot: actual test1 vs k-step-ahead preds (aligned)
ts.plot(window(y_test1, start = time(y_test1)[k + 1]), k_step_test1,
        col = c("blue", "red"), lwd = c(1,1),
        main = paste0("Test1 actuals vs ", k, "-step-ahead predictions (no refit)"),
        ylab = "Temperature", xlab = "Time")
legend("topleft", legend = c("Test1 actuals", paste0(k, "-step ahead")),
       col = c("blue", "red"), lwd = c(2,2), bty = "n")

```

## Adding residuals to df

```{r}
df_he$res <- fit$residuals
```

## Checking where wind comes from

## Regimes for wind direction

```{r}
wind_regime <- function(wd, rot = 45) {
  wd <- (wd - rot) %% 360   # rotate regimes clockwise by rot degrees
  out <- rep(NA_character_, length(wd))

  out[wd >   0 & wd <=  90] <- "R1"
  out[wd >  90 & wd <= 180] <- "R2"
  out[wd > 180 & wd <= 270] <- "R3"
  out[wd > 270 & wd <  360] <- "R4"
  out[wd == 0]              <- "R4"

  factor(out, levels = c("R1","R2","R3","R4"))
}

df_he$regime <- wind_regime(df_he$Vindriktning, rot = 45)

```

```{r}
plot_regime_compass <- function(rot = 0) {
  regimes <- data.frame(
    name = c("R1","R2","R3","R4"),
    from = c(0, 90, 180, 270) + rot,
    to   = c(90, 180, 270, 360) + rot
  )

  plot(0, 0, type="n", asp=1, xlim=c(-1.2,1.2), ylim=c(-1.2,1.2),
       axes=FALSE, xlab="", ylab="")
  symbols(0, 0, circles=1, inches=FALSE, add=TRUE)

  deg2rad <- function(deg) (90 - deg) * pi/180  # 0° = North at top

  for (i in 1:nrow(regimes)) {
    a1 <- deg2rad(regimes$from[i])
    a2 <- deg2rad(regimes$to[i])
    th <- seq(a1, a2, length.out = 200)

    polygon(c(0, cos(th), 0), c(0, sin(th), 0), border="black")
    mid <- deg2rad((regimes$from[i] + regimes$to[i]) / 2)
    text(0.75*cos(mid), 0.75*sin(mid), regimes$name[i], cex=1.2)
  }

  text(0,  1.1, "N"); text(1.1, 0, "E"); text(0, -1.1, "S"); text(-1.1, 0, "W")
}

plot_regime_compass(rot =45)

```

```{r}
labels16 <- c("N","NNE","NE","ENE","E","ESE","SE","SSE",
              "S","SSW","SW","WSW","W","WNW","NW","NNW")
# speed bins similar to your example (m/s)
spd_breaks <- c(0,2,4,6,8,10,12,14,16,18,20,Inf)
spd_labels <- c("0–2","2–4","4–6","6–8","8–10","10–12",
                "12–14","14–16","16–18","18–20","20+")
rose_df <- df_he %>%
  filter(!is.na(Vindriktning), !is.na(Vindhastighet)) %>%
  mutate(
    wd = Vindriktning %% 360,
    dir16 = labels16[(floor((wd + 11.25) / 22.5) %% 16) + 1],
    dir16 = factor(dir16, levels = labels16, ordered = TRUE),
    spd_bin = cut(Vindhastighet,
                  breaks = spd_breaks, labels = spd_labels,
                  include.lowest = TRUE, right = FALSE)
  ) %>%
  count(dir16, spd_bin) %>%
  mutate(pct = 100 * n / sum(n)) 

rose_df <- rose_df %>%
  mutate(dir16 = factor(dir16, levels = labels16, ordered = TRUE))

ggplot(rose_df, aes(x = dir16, y = pct, fill = spd_bin)) +
  geom_col(width = 1, color = "grey30") +
  coord_polar(start = -pi/8 + pi/16, direction = -1) +  # N at top, clockwise, centered
  labs(x = NULL, y = NULL)

```

```{r}
rose_mean <- df_he %>%
  filter(!is.na(regime), !is.na(Vindhastighet)) %>%
  mutate(regime = factor(regime, levels = c("R1","R2","R3","R4"))) %>%
  group_by(regime) %>%
  summarise(mean_speed = mean(Vindhastighet), .groups = "drop")

ggplot(rose_mean, aes(regime, mean_speed)) +
  geom_col(width = 1, color = "black") +
  coord_polar(start = pi/2, direction = -1) +
  labs(x = NULL, y = "Mean Vindhastighet (m/s)",
       title = "Helsingborg: mean wind speed by regime")

```

## Add danish weather station

```{r}
setwd("..")
source("Code/DenmarkFunctions.r")
```

```{r}
#Can see locations of weather stations here https://www.dmi.dk/maalinger see DenmarkData file to search for station ids
station_id = "06079" #Anholt maybe not that interesting?
station_id <- "06041" #Skagen Fyr has >0.1 corss correlation in R4, but is very far away...
station_id <- "06180" #copenhagen airport could be good?
station_id <- "06049" #Gniben also potential good alternative for wind from the west
station_id <- "06168" #Nakkehoved Fyr has some correlations in R3 for example
station_id <- "06170" #Roskilde Lufthavn has a fair bit of correlation in general
station_id <- "06073"#Sletterhage Fyr. Some lagged correlation in R2 and R3
station_id <- "06120" #H.C Andersen Airport. Pretty strong lagged correlation in R3!

# Get available parameters for the station
params <- c("temp_dry","wind_dir","wind_speed")

start_time <- format(as.POSIXct(df_he$ts_utc[1], tz = "UTC"),
       "%Y-%m-%dT%H:%M:%SZ")
end_time <- format(as.POSIXct(df_he$ts_utc[nrow(df_he)], tz = "UTC"),
       "%Y-%m-%dT%H:%M:%SZ")

# Fetch observations
observations <- get_observations_for_station(
  station_id = station_id,
  parameters = params,   # or subset of parameters
  start_dt   = start_time,
  end_dt     = end_time,
  limit      = 20000
)
```

```{r}
full_seq <- seq(
  from = min(observations$observed),
  to   = max(observations$observed),
  by   = "10 min"
)

# Find missing timestamps
missing_times <- full_seq[!full_seq %in% observations$observed]

# Summary
length(missing_times)  # how many are missing
missing_times           # which timestamps are missing
```

```{r}
#process data so it is hourly
hourly_dmi <- process_hourly_data(observations)
```

```{#rename columns to match swedish data}
hourly_dmi <- hourly_dmi %>%
  rename(Lufttemperatur = temp_dry, Vindriktning = wind_dir, Vindhastighet = wind_speed, ts_utc = observed)
```

## Filtering based on regime

```{r}
df_he_R <- filter(df_he, regime == "R3")

# times where df_h is R1<
t_R <- df_he_R$ts_utc

# keep those times in df_ä
#df_temp <- df_fa
df_temp <- hourly_dmi 
df_x <- df_temp[df_temp$ts_utc %in% t_R, ]

#idx_missing <- which(is.na(df_x$Lufttemperatur))  # TRUE for NA and NaN

r = ccf(df_he_R$res, df_x$Lufttemperatur, lag.max = 50, na.action = na.pass, plot = FALSE)
pos <- r$lag >= 0

n <- sum(complete.cases(df_he_R$res, df_x$Lufttemperatur))
ci <- 1.96 / sqrt(n)

plot(r$lag[pos], r$acf[pos], type = "h",
     xlab = "Lag", ylab = "CCF (positive lags)", main = "CCF")
abline(h = 0)
abline(h = c(-ci, ci), lty = 2)
```

# R1:

# R2:

# R3:

# R4: Falsterbo! (Eller R2 med roterad regim?)

## CCF R3 Falsterbo

```{r}
#df_he_R <- diff(df_he_R$res, lag = 1)
#df_x <- diff(df_x$Lufttemperatur, lag = 1)
ccf(df_he_R$res, df_x$Lufttemperatur, lag.max = 50, na.action = na.pass)
```

```{r}

```
