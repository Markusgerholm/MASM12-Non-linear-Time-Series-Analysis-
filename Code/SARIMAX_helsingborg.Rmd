---
title: "SARIMAX_helsingborg"
output: html_document
---

## Loading data

```{r}
library(zoo)
library(forecast)
library(ggplot2)
library(dplyr)
```

```{r}
setwd("..")
source("Code/read_data2.r")
```

## Regular ARIMA model

```{r}
start <- 3200
end <- 5900
#df_he <- helsingborg_2024[start:end, ] # center

h <- 500
freq <- 24
# full series from your dataframe
y_all <- ts(helsingborg_2024$Lufttemperatur, frequency = 24)

# convert row indices to ts "time" values
t_start <- 1 + (start - 1) / freq
t_end   <- 1 + (end   - 1) / freq
t_test_start <- 1 + (end) / freq          # row end + 1
t_test_end   <- 1 + (end + h - 1) / freq  # row end + h

# train/test as ts
y_train <- window(y_all, start = t_start, end = t_end)
y_test  <- window(y_all, start = t_test_start, end = t_test_end)

# additional test set roughly 6 months forward in time

gap <- 2000  

t_test1_start <- t_test_start + gap / freq
t_test1_end   <- t_test1_start + (h - 1) / freq

y_test1 <- window(y_all, start = t_test1_start, end = t_test1_end)
y_train_test1 <- window(y_all, start = t_start, end = t_test1_end) # training data + test data

p <- rep(0, 18)
p[1] <- NA
p[2] <- NA
p[11] <- 0
p[18] <- NA

q <- rep(0, 23)
q[2] <- NA
q[20] <- NA
q[23] <- NA

fit <- Arima(y_train,
                 order = c(18,0,23),
                fixed = c(p,q,NA),
                 seasonal = c(0,1,1))
```

```{r}
wind_regime4 <- function(wd, ws, rot = 45) {
  wd <- (wd - rot) %% 360
  out <- rep(NA_character_, length(wd))
  # Only assign R1–R4 when wind speed is not zero, when zero, set regime to R0
  idx <- !is.na(ws) & ws != 0 & !is.na(wd)
  out[!is.na(ws) & ws == 0] <- "R0"
  out[idx & wd >   0 & wd <=  90] <- "R1"
  out[idx & wd >  90 & wd <= 180] <- "R2"
  out[idx & wd > 180 & wd <= 270] <- "R3"
  out[idx & wd > 270 & wd <  360] <- "R4"
  out[idx & wd == 0]              <- "R4"
  factor(out, levels = c("R0","R1","R2","R3","R4"))
}
helsingborg_2024$regime <- wind_regime4(helsingborg_2024$Vindriktning, helsingborg_2024$Vindhastighet, rot = 45)
```

```{r}
table(helsingborg_2024$regime, useNA = "ifany")
```

## Regime switching model
```{r}
#df_hö <- helsingborg_2024
#df_ul <- ullared_2024
#df_he <- helsingborg_2024
#df_ro <- roskilde_2024
#df_kb <- köbenhavn_2024
#df_sl <- slatterhage_2024
#df_gn <- gniben_2024
```

## Kalman imputation for missing values

# Sletterhage
```{r}
y_obs <- df_sl$Lufttemperatur
fit_sl <- forecast::auto.arima(y_obs)
kr <- KalmanRun(y_obs, fit_sl$model)
id_na <- which(is.na(y_obs))
# predicted observation at each time: Z %*% alpha_t
y_hat <- as.numeric(fit_sl$model$Z %*% t(kr$states))
# impute only where missing
y_filled <- y_obs
y_filled[id_na] <- y_hat[id_na]
df_sl$Lufttemperatur[id_na] <- y_hat[id_na]
```

# Ullared
```{r}
y_obs <- df_ul$Lufttemperatur
fit_ul <- forecast::auto.arima(y_obs)
kr <- KalmanRun(y_obs, fit_ul$model)
id_na <- which(is.na(y_obs))
# predicted observation at each time: Z %*% alpha_t
y_hat <- as.numeric(fit_ul$model$Z %*% t(kr$states))
# impute only where missing
y_filled <- y_obs
y_filled[id_na] <- y_hat[id_na]
df_ul$Lufttemperatur[id_na] <- y_hat[id_na]

```

## Full hourly data frame

```{r}
df_full <- df_he %>%
  select(ts_utc, y = Lufttemperatur, regime) %>%
  inner_join(df_hö      %>% select(ts_utc, hö    = Lufttemperatur), by = "ts_utc") %>%
  inner_join(df_kb      %>% select(ts_utc, kb    = Lufttemperatur), by = "ts_utc") %>%
  inner_join(df_sl      %>% select(ts_utc, sl    = Lufttemperatur), by = "ts_utc") %>%
  inner_join(df_ul      %>% select(ts_utc, ul    = Lufttemperatur), by = "ts_utc") %>%
  arrange(ts_utc)
```

## Full hourly data frame with lagged station series

```{r}
df_full <- df_full %>%
  mutate(
    # Hörby lags
    hö_L0  = hö,
    hö_L23 = lag(hö, 23),
    hö_L47 = lag(hö, 47),

    # KB lags
    kb_L0  = kb,
    kb_L10 = lag(kb, 10),
    kb_L47 = lag(kb, 47),

    # SL lags
    sl_L1  = lag(sl, 1),
    sl_L12 = lag(sl, 12),
    sl_L24 = lag(sl, 24),

    # UL lags
    ul_L0  = ul,
    ul_L1  = lag(ul, 1),
    ul_L25 = lag(ul, 25)
  )
```

## Gating xregs by regime

```{r}
df_full <- df_full %>%
  mutate(
    # R1 uses Hörby
    R1_x0  = if_else(regime == "R1", hö_L0,  0),
    R1_x23 = if_else(regime == "R1", hö_L23, 0),
    R1_x47 = if_else(regime == "R1", hö_L47, 0),

    # R2 uses KB
    R2_x0  = if_else(regime == "R2", kb_L0,  0),
    R2_x10 = if_else(regime == "R2", kb_L10, 0),
    R2_x47 = if_else(regime == "R2", kb_L47, 0),

    # R3 uses SL
    R3_x1  = if_else(regime == "R3", sl_L1,  0),
    R3_x12 = if_else(regime == "R3", sl_L12, 0),
    R3_x24 = if_else(regime == "R3", sl_L24, 0),

    # R4 uses UL
    R4_x0  = if_else(regime == "R4", ul_L0,  0),
    R4_x1  = if_else(regime == "R4", ul_L1,  0),
    R4_x25 = if_else(regime == "R4", ul_L25, 0)
  )

```

## Building X matrix and fitting one ARIMAX on full hourly y

```{r}
X_cols <- c(
  "R1_x0","R1_x23","R1_x47",
  "R2_x0","R2_x10","R2_x47",
  "R3_x1","R3_x12","R3_x24",
  "R4_x0","R4_x1","R4_x25"
)

df_cc <- df_full %>%
  filter(complete.cases(y, across(all_of(X_cols))))  # drops rows where active-regime xreg is NA

y_all <- ts(df_cc$y, frequency = 24)
X_all <- as.matrix(df_cc[, X_cols])

fixed_base <- c(p, q, NA)                     # your 18 AR + 23 MA + seasonal MA(1)
fixed_all  <- c(fixed_base, rep(NA, ncol(X_all)))

fit_sarimax <- Arima(
  y_all,
  order    = c(18,0,23),
  seasonal = c(0,1,1),
  xreg     = X_all,
  fixed    = fixed_all,
  include.mean = FALSE
)

summary(fit_sarimax)

```

## Plot of fitted values and observations

```{r}
plot(df_cc$ts_utc, df_cc$y, type = "l", col = "blue",
     xlab = "Time", ylab = "Temperature")
lines(df_cc$ts_utc, fit_sarimax$fitted, col = "red")
```
## Comparing to same data but only SARIMA
```{r}
# Make y on the SAME sample you evaluate SARIMAX on
y_cc <- ts(df_cc$y, frequency = 24)

# Reuse the same SARIMA structure + coefficients from your original baseline:
fit_cc_base <- Arima(y_cc, model = fit)
summary(fit_cc_base)
```


```{r}
plot(df_cc$ts_utc, df_cc$y, type = "l", col = "blue",
     xlab = "Time", ylab = "Temperature")
lines(df_cc$ts_utc, fit_cc_base$fitted, col = "red")
```
## Checking RMSE for test set

```{r}
fit_test <- Arima(y_train_test1, model = fit_sarimax)
```



## Kalman filter - potential extension to code above, lets parameters vary over time and enables predictions of inputs

```{r}
setwd("..")
source("Code/KalmanInputR1.R")
```


```{r}
out_R1 <- predValuesInputR1(hörby_R1$Lufttemperatur, kStep = 1)
```

## RMSE

```{r}
x <- hörby_R1$Lufttemperatur
fc <- out_R1$xhatk[, 1]          # forecast for next time step
t0 <- 41
fc2 <- fc[t0:(length(x)-1)]
x2  <- x[(t0+1):length(x)]
RMSE_R1 <- sqrt(mean((x2 - fc2)^2, na.rm = TRUE))
RMSE_R1
```

## Plot of prediction
```{r}
plot(x, type = "l", col = "blue")
lines(fc, col = "red")
```

## Plot of states

```{r}
theta <- out_R1$theta
par(mfrow = c(2,2), mar = c(4,4,2,1))

plot(theta[1,], type="l", xlab="t", ylab="value", main="phi1")
plot(theta[2,], type="l", xlab="t", ylab="value", main="theta1 (ma1)")
plot(theta[3,], type="l", xlab="t", ylab="value", main="theta2 (ma2)")
plot(theta[4,], type="l", xlab="t", ylab="value", main="theta3 (ma3)")
```

